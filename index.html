<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DurianStory | ระบบแท็กทุเรียน</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Google Fonts for Premium Look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Kanit', 'sans-serif'],
            serif: ['Sarabun', 'serif'],
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar for the list */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    /* Hide scrollbar for standard elements to keep UI clean if needed */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="bg-emerald-50 text-slate-800 font-sans antialiased">

  <!-- ========================================== -->
  <!-- ADMIN VIEW -->
  <!-- ========================================== -->
  <div id="admin-view" class="min-h-screen transition-opacity duration-300">
    <!-- Admin Header -->
    <header class="bg-emerald-900 text-white shadow-md py-4 px-6 sticky top-0 z-10">
      <div class="max-w-5xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="tree-deciduous" class="w-8 h-8 text-amber-400"></i>
          <h1 class="text-xl font-bold tracking-wide">DurianStory <span class="font-light text-emerald-300">| ระบบจัดการแท็ก</span></h1>
        </div>
        <div class="text-sm bg-emerald-800 px-3 py-1 rounded-full border border-emerald-700">
          โหมดเจ้าของสวน
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
      
      <!-- Form Section -->
      <div class="bg-white rounded-2xl shadow-sm border border-emerald-100 p-6 h-fit">
        <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2 text-emerald-900">
          <i data-lucide="tag" class="w-6 h-6 text-emerald-600"></i>
          สร้างแท็กทุเรียนใหม่
        </h2>
        
        <form id="create-tag-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">สายพันธุ์</label>
              <select id="input-variety" required class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all bg-white">
                <option value="หมอนทอง (Monthong)">หมอนทอง</option>
                <option value="ชะนี (Chanee)">ชะนี</option>
                <option value="ก้านยาว (Kan Yao)">ก้านยาว</option>
                <option value="พวงมณี (Puang Manee)">พวงมณี</option>
                <option value="นกหยิบ (Nok Yip)">นกหยิบ</option>
                <option value="หลงลับแล (Long Laplae)">หลงลับแล</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อสวน</label>
              <input id="input-orchard" required type="text" placeholder="เช่น สวนลุงสมหมาย" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">โซน / แปลง</label>
              <input id="input-plot" required type="text" placeholder="เช่น แปลง A" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">หมายเลขต้น</label>
              <input id="input-treeId" required type="text" placeholder="เช่น ต้นที่ 42" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">อายุต้น (ปี)</label>
              <input id="input-treeAge" required type="number" placeholder="เช่น 15" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เก็บเกี่ยว</label>
              <input id="input-harvest" required type="date" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ปลูก / เกษตรกร</label>
            <input id="input-farmer" required type="text" placeholder="ชื่อของคุณ" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">เรื่องราวความประทับใจ (Storytelling)</label>
            <textarea id="input-story" required rows="4" placeholder="เล่าเรื่องราวความใส่ใจ ที่มาของต้นทุเรียน หรือข้อความถึงลูกค้า เพื่อสร้างมูลค่าทางใจ..." class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
          </div>

          <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-lg shadow-md transition-colors flex justify-center items-center gap-2">
            <i data-lucide="qr-code" class="w-5 h-5"></i>
            สร้างข้อมูลและ QR Code
          </button>
        </form>
      </div>

      <!-- List Section -->
      <div class="space-y-6">
        <div class="bg-emerald-900 rounded-2xl p-6 text-white shadow-lg overflow-hidden relative">
          <div class="absolute -right-6 -top-6 text-emerald-800 opacity-50">
             <i data-lucide="tree-deciduous" class="w-32 h-32"></i>
          </div>
          <h2 class="text-xl font-bold mb-2 relative z-10">ทำไมต้องสร้างเรื่องราว?</h2>
          <p class="text-emerald-100 text-sm leading-relaxed relative z-10 font-serif">
            การติดแท็ก QR Code ที่บอกเล่าที่มาของทุเรียน ช่วยยกระดับทุเรียนธรรมดาให้เป็น "ของขวัญพรีเมียม" ลูกค้าจะสัมผัสได้ถึงความใส่ใจ รู้ว่ามาจากไหน และมั่นใจในคุณภาพ สร้างฐานลูกค้าประจำได้ง่ายขึ้น
          </p>
        </div>

        <h3 class="text-xl font-semibold text-emerald-900 flex items-center gap-2">
          <i data-lucide="check-circle-2" class="w-5 h-5"></i> ทุเรียนที่สร้างแท็กแล้ว
        </h3>
        
        <div id="durian-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
          <!-- List items will be rendered here by JS -->
        </div>
      </div>
    </main>
  </div>


  <!-- ========================================== -->
  <!-- CONSUMER VIEW (Hidden by default) -->
  <!-- ========================================== -->
  <div id="consumer-view" class="hidden min-h-screen bg-[#faf9f6] text-gray-800 font-serif selection:bg-amber-200">
    <!-- Floating Back Button (Hidden if scanned directly) -->
    <button 
      id="back-btn"
      onclick="showAdminView()"
      class="fixed top-4 left-4 z-50 bg-white/80 backdrop-blur-md p-2 rounded-full shadow-lg text-emerald-800 hover:bg-white transition-all border border-gray-100"
      title="กลับไปหน้าแอดมิน"
    >
      <i data-lucide="arrow-left" class="w-6 h-6"></i>
    </button>

    <!-- Hero Image Section -->
    <div class="relative h-[40vh] min-h-[300px] w-full bg-emerald-900">
      <img 
        id="cv-image"
        src="" 
        alt="Origin of Durian" 
        class="w-full h-full object-cover opacity-80"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-[#faf9f6] via-transparent to-transparent"></div>
      
      <div class="absolute bottom-0 left-0 right-0 p-6 text-center transform translate-y-1/4">
        <div class="inline-block bg-white p-6 rounded-2xl shadow-xl border border-amber-100 max-w-sm w-full mx-auto relative overflow-hidden">
          <!-- Decorative corners -->
          <div class="absolute top-2 left-2 w-4 h-4 border-t-2 border-l-2 border-amber-300"></div>
          <div class="absolute top-2 right-2 w-4 h-4 border-t-2 border-r-2 border-amber-300"></div>
          <div class="absolute bottom-2 left-2 w-4 h-4 border-b-2 border-l-2 border-amber-300"></div>
          <div class="absolute bottom-2 right-2 w-4 h-4 border-b-2 border-r-2 border-amber-300"></div>

          <p class="text-amber-600 text-xs font-bold tracking-widest uppercase mb-2 font-sans">Premium Selection</p>
          <h1 id="cv-variety" class="text-3xl font-bold text-emerald-900 mb-1 font-sans"></h1>
          <p class="text-gray-500 text-sm font-sans flex justify-center items-center gap-1">
            <i data-lucide="map-pin" class="w-3 h-3"></i> <span id="cv-orchardName1"></span>
          </p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-2xl mx-auto px-6 pt-24 pb-16">
      
      <!-- Certificate / Specs -->
      <div class="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100 mb-8 font-sans">
        <h2 class="text-center text-lg font-bold text-emerald-900 mb-6 border-b border-gray-100 pb-4">
          ข้อมูลประจำตัวทุเรียน (Identity)
        </h2>
        
        <div class="grid grid-cols-2 gap-y-6 gap-x-4">
          <div class="flex items-start gap-3">
            <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600">
              <i data-lucide="map-pin" class="w-5 h-5"></i>
            </div>
            <div>
              <p class="text-xs text-gray-400 font-medium">แหล่งปลูก</p>
              <p id="cv-orchardName2" class="text-sm font-semibold text-gray-800"></p>
              <p id="cv-plot" class="text-xs text-gray-500"></p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600">
              <i data-lucide="tree-deciduous" class="w-5 h-5"></i>
            </div>
            <div>
              <p class="text-xs text-gray-400 font-medium">ข้อมูลต้น</p>
              <p id="cv-treeId" class="text-sm font-semibold text-gray-800"></p>
              <p class="text-xs text-gray-500">อายุ <span id="cv-treeAge"></span> ปี</p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600">
              <i data-lucide="calendar" class="w-5 h-5"></i>
            </div>
            <div>
              <p class="text-xs text-gray-400 font-medium">วันที่เก็บเกี่ยว</p>
              <p id="cv-harvestDate" class="text-sm font-semibold text-gray-800"></p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600">
              <i data-lucide="leaf" class="w-5 h-5"></i>
            </div>
            <div>
              <p class="text-xs text-gray-400 font-medium">ผู้ดูแล</p>
              <p id="cv-farmerName1" class="text-sm font-semibold text-gray-800"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- The Story Section -->
      <div class="relative mb-12 text-center">
        <div class="absolute left-1/2 -translate-x-1/2 -top-6 bg-[#faf9f6] px-4">
           <i data-lucide="heart" class="w-8 h-8 text-amber-500 fill-amber-500/20"></i>
        </div>
        <div class="border-t border-b border-amber-200 py-10 px-6">
          <h3 class="text-xl font-bold text-amber-800 mb-6 font-sans">เรื่องราวจากสวนถึงมือคุณ</h3>
          <p id="cv-story" class="text-gray-700 text-lg leading-relaxed italic relative z-10">
          </p>
          <div class="mt-8">
            <p id="cv-farmerName2" class="text-emerald-900 font-bold font-sans"></p>
            <p id="cv-orchardName3" class="text-sm text-gray-500 font-sans"></p>
          </div>
        </div>
      </div>

      <!-- Footer Guarantee -->
      <div class="text-center bg-emerald-900 text-white p-8 rounded-2xl relative overflow-hidden">
        <div class="absolute -left-10 -bottom-10 opacity-10">
          <i data-lucide="qr-code" class="w-40 h-40"></i>
        </div>
        <div class="relative z-10">
          <h3 class="text-lg font-bold mb-2 font-sans tracking-wide">AUTHENTICITY GUARANTEED</h3>
          <p class="text-emerald-200 text-sm font-sans max-w-sm mx-auto">
            ทุเรียนทุกลูกที่ได้รับแท็กนี้ สามารถตรวจสอบย้อนกลับได้ถึงต้นกำเนิด เพื่อความมั่นใจในคุณภาพระดับพรีเมียม
          </p>
          <p class="mt-6 text-xs text-emerald-400/60 font-mono">
            TAG ID: <span id="cv-tagId"></span>
          </p>
        </div>
      </div>

    </div>
  </div>

  <!-- ========================================== -->
  <!-- JAVASCRIPT LOGIC -->
  <!-- ========================================== -->
  <script>
    // ⚠️ นำ URL ที่ได้จาก Google Apps Script มาใส่ตรงนี้ (อยู่ในเครื่องหมายคำพูด)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqg7ql14GYoZ7RXp-KpDQRMObXaFdivT7C7KKdIJk-mhPFMmhUOLgrVyX-2GRJiV1n/exec'; 

    let durians = [];
    let isDirectScan = false; // ตัวแปรเช็กว่าเข้ามาจากการสแกน QR โค้ดโดยตรงหรือไม่

    // Format Date Function
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });
    }

    // Render List
    function renderList(isLoading = false) {
      const listContainer = document.getElementById('durian-list');
      
      if (isLoading) {
        listContainer.innerHTML = `
          <div class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-500 font-sans flex flex-col items-center gap-3">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-emerald-500"></i>
            <p>กำลังโหลดข้อมูล...</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      if (durians.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300 text-gray-500 font-sans">
            ยังไม่มีข้อมูลทุเรียน เริ่มสร้างแท็กแรกของคุณเลย
          </div>
        `;
        return;
      }

      let html = '';
      // ดึง URL ปัจจุบัน เพื่อไปสร้างลิงก์สำหรับ QR Code
      const currentBaseUrl = window.location.origin + window.location.pathname;

      durians.forEach((durian, index) => {
        const shortId = durian.id.split('-')[1] || durian.id;
        // สร้าง URL ที่จะไปหน้าลูกค้าโดยตรงผ่านพารามิเตอร์ ?id=
        const scanUrl = `${currentBaseUrl}?id=${durian.id}`;
        const qrImgSrc = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(scanUrl)}`;

        html += `
          <div class="bg-white p-5 rounded-xl shadow-sm border border-emerald-100 flex flex-col sm:flex-row gap-4 items-start sm:items-center transition-all hover:shadow-md font-sans">
            <div class="flex gap-4 items-start w-full sm:w-auto flex-1">
              <div class="shrink-0 bg-gray-50 p-2 rounded-lg border border-gray-200">
                <img 
                  src="${qrImgSrc}" 
                  alt="QR Code" 
                  class="w-20 h-20"
                />
                <p class="text-[10px] text-center mt-1 text-gray-500 font-mono">${shortId}</p>
              </div>
              
              <div class="flex-1">
                <div class="flex justify-between items-start mb-1">
                  <h4 class="font-bold text-emerald-900 text-lg">${durian.variety}</h4>
                  <span class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded-full font-medium">
                    ${durian.treeAge} ปี
                  </span>
                </div>
                <p class="text-sm text-gray-600 mb-1 flex items-center gap-1">
                  <i data-lucide="map-pin" class="w-3 h-3"></i> ${durian.orchardName} - ${durian.plot}
                </p>
                <p class="text-xs text-gray-500 mb-3 flex items-center gap-1">
                  <i data-lucide="tree-deciduous" class="w-3 h-3"></i> ${durian.treeId}
                </p>
                
                <div class="flex gap-2 flex-wrap">
                  <a href="${qrImgSrc}" target="_blank" download="QR_${durian.id}.png" class="text-sm px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors font-medium cursor-pointer flex items-center">
                    ดู QR Code
                  </a>
                  <button 
                    onclick="simulateScan(${index})"
                    class="text-sm px-3 py-1.5 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-md transition-colors flex items-center gap-1 font-medium"
                  >
                    <i data-lucide="info" class="w-4 h-4"></i> จำลองหน้าลูกค้า
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ปุ่มลบแท็ก -->
            <button 
              onclick="deleteTag(${index}, '${durian.id}')"
              class="text-sm px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 rounded-md transition-colors flex items-center gap-1 font-medium self-end sm:self-center shrink-0"
              title="ลบแท็กนี้"
            >
              <i data-lucide="trash-2" class="w-4 h-4"></i> ลบ
            </button>
          </div>
        `;
      });
      
      listContainer.innerHTML = html;
      lucide.createIcons();
    }

    // Fetch data from Google Sheets & Handle Routing (URL Params)
    async function loadData() {
      // ดึงค่า ?id=... จาก URL
      const urlParams = new URLSearchParams(window.location.search);
      const viewId = urlParams.get('id');

      if (viewId) {
        // ถ้าเข้าจากลิงก์สแกน QR Code (มี ?id=) ให้ซ่อนฟอร์มไปเลย
        document.getElementById('admin-view').classList.add('hidden');
        isDirectScan = true;
      }

      if (!SCRIPT_URL) {
        if (!viewId) renderList();
        return;
      }

      if (!isDirectScan) renderList(true); // โชว์โหลดเฉพาะหน้าแอดมิน

      try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();
        durians = data;

        if (viewId) {
          // ค้นหาทุเรียนจาก ID
          const targetIndex = durians.findIndex(d => d.id === viewId);
          if (targetIndex !== -1) {
            simulateScan(targetIndex);
          } else {
            alert('ไม่พบข้อมูลทุเรียนแท็กนี้ หรือข้อมูลอาจถูกลบไปแล้ว');
            window.location.href = window.location.pathname; // พาค่า ?id ออกเพื่อกลับหน้าหลัก
          }
        } else {
          renderList();
        }
      } catch (error) {
        console.error('Error loading data:', error);
        if(!isDirectScan) {
          document.getElementById('durian-list').innerHTML = `
            <div class="text-center py-10 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>
          `;
        }
      }
    }

    // ฟังก์ชันลบแท็ก
    async function deleteTag(index, id) {
      // แสดง popup ยืนยันก่อนลบ
      if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบแท็กนี้? ข้อมูลจะถูกลบออกอย่างถาวร')) {
        return; 
      }

      // เก็บข้อมูลเดิมไว้เผื่อกรณี API ล้มเหลว
      const previousDurians = [...durians];

      // อัปเดตหน้าจอทันทีเพื่อให้รู้สึกว่าระบบทำงานเร็ว (Optimistic UI Update)
      durians.splice(index, 1);
      renderList();

      if (!SCRIPT_URL) {
        alert('ลบแท็กสำเร็จ (โหมดจำลอง ยังไม่ได้ต่อ Google Sheets)');
        return;
      }

      try {
        // ส่งคำสั่ง action: 'delete' ไปยัง Google Apps Script
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify({ action: 'delete', id: id })
        });

        const result = await response.json();
        
        if (result.status !== 'success') {
          throw new Error(result.message || 'ลบไม่สำเร็จ');
        }
        
        // ลบสำเร็จ
        // (ไม่ต้อง alert ทุกครั้งเพื่อความรวดเร็ว แต่ถ้าอยากให้เตือนก็เปิดคอมเมนต์ด้านล่างได้)
        // alert('ลบข้อมูลใน Google Sheets สำเร็จ');

      } catch (error) {
        console.error('Error deleting data:', error);
        alert('เกิดข้อผิดพลาดในการลบข้อมูล ระบบจะคืนค่าข้อมูลเดิม');
        // หากลบไม่สำเร็จ ให้คืนค่าข้อมูลเดิมที่หน้าจอ
        durians = previousDurians;
        renderList();
      }
    }

    // Handle Form Submit
    document.getElementById('create-tag-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> กำลังบันทึกข้อมูล...';
      submitBtn.disabled = true;
      lucide.createIcons();
      
      const newDurian = {
        id: `DUR-${Date.now().toString().slice(-6)}-${Math.floor(Math.random() * 1000)}`,
        variety: document.getElementById('input-variety').value,
        orchardName: document.getElementById('input-orchard').value,
        plot: document.getElementById('input-plot').value,
        treeId: document.getElementById('input-treeId').value,
        treeAge: document.getElementById('input-treeAge').value,
        harvestDate: document.getElementById('input-harvest').value,
        farmerName: document.getElementById('input-farmer').value,
        story: document.getElementById('input-story').value,
        image: 'https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
      };

      if (!SCRIPT_URL) {
        durians.unshift(newDurian);
        renderList();
        this.reset();
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        alert('สร้างแท็กสำเร็จ (โหมดจำลอง ยังไม่ได้ต่อ Google Sheets)');
        return;
      }

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(newDurian)
        });

        durians.unshift(newDurian);
        renderList();
        this.reset();
        alert('บันทึกข้อมูลลง Google Sheets และสร้าง QR Code สำเร็จ!');
        
      } catch (error) {
        console.error('Error saving data:', error);
        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
      } finally {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        lucide.createIcons();
      }
    });

    // View Navigation
    function simulateScan(index) {
      const durian = durians[index];
      
      // Populate Consumer View Data
      document.getElementById('cv-image').src = durian.image || 'https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
      document.getElementById('cv-variety').textContent = durian.variety;
      document.getElementById('cv-orchardName1').textContent = durian.orchardName;
      document.getElementById('cv-orchardName2').textContent = durian.orchardName;
      document.getElementById('cv-orchardName3').textContent = durian.orchardName;
      document.getElementById('cv-plot').textContent = durian.plot;
      document.getElementById('cv-treeId').textContent = durian.treeId;
      document.getElementById('cv-treeAge').textContent = durian.treeAge;
      
      let hDate = durian.harvestDate;
      if (hDate && hDate.includes('T')) hDate = hDate.split('T')[0];
      document.getElementById('cv-harvestDate').textContent = formatDate(hDate);
      
      document.getElementById('cv-farmerName1').textContent = durian.farmerName;
      document.getElementById('cv-farmerName2').textContent = durian.farmerName;
      document.getElementById('cv-story').textContent = `"${durian.story}"`;
      document.getElementById('cv-tagId').textContent = durian.id;

      // จัดการปุ่ม Back (ถ้าลูกค้าแสกนเข้ามาเองตรงๆ ไม่ควรมีปุ่มกดย้อนกลับไปหน้าจัดการหลังบ้าน)
      const backBtn = document.getElementById('back-btn');
      if (isDirectScan) {
        backBtn.style.display = 'none';
      } else {
        backBtn.style.display = 'block';
      }

      // Switch Views
      document.getElementById('admin-view').classList.add('hidden');
      document.getElementById('consumer-view').classList.remove('hidden');
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    function showAdminView() {
      // ใช้ได้เฉพาะเวลาจำลองสแกนจากหน้าแอดมิน
      document.getElementById('consumer-view').classList.add('hidden');
      document.getElementById('admin-view').classList.remove('hidden');
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      loadData(); // ทำหน้าที่โหลดชีต และ เช็กว่ามีการสแกน QR Code (มี ?id) หรือไม่
    });
  </script>
</body>
</html>